@model ACC_DEV.ViewModel.ChartOfAllAccViewModel
@{
    ViewData["Title"] = "RefChartOfAccs";
    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
<!-- ============================================================== -->
<!-- Main wrapper - style you can find in pages.scss -->
<!-- ============================================================== -->
<div id="main-wrapper">
    <!-- ============================================================== -->
    <!-- Page wrapper  -->
    <!-- ============================================================== -->
    <div class="page-wrapper">
        <!-- ============================================================== -->
        <!-- Container fluid  -->
        <!-- ============================================================== -->
        <div class="container-fluid">

            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h4 class="text-themecolor">Master Reference</h4>
                </div>
                <div class="col-md-7 align-self-center text-right">
                    <div class="d-flex justify-content-end align-items-center">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                            <li class="breadcrumb-item active">Master Reference</li>
                        </ol>
                        <button type="button" onclick="location.href='@Url.Action("Create", "refChartOfAccs")'" class="btn btn-info d-none d-lg-block m-l-15"><i class="fa fa-plus-circle"></i> Create New Chart Of Accounts</button>
                    </div>
                </div>
            </div>
            <div class="row page-titles">
                <div class="col-md-5 align-self-center">
                    <h1 class="text-themecolor">Chart Of Accounts</h1>
                </div>
                <div class="col-md-3 align-self-center text-right">
                </div>
                <!-- Search-->
                <div class="col-md-4 align-self-center text-right">
                    @using (Html.BeginForm("Index", "RefChartOfAccs", new { searchString = "" }, FormMethod.Get))
                    {
                        <div class="input-group">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchType" id="searchByInvoice" value="AccountCode" checked>
                                <label class="form-check-label" for="searchByInvoice">Account Code</label>
                            </div>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchType" id="searchByJob" value="AccountName">
                                <label class="form-check-label" for="searchByJob">Account Name</label>
                            </div>

                            <input type="text" id="searchString" name="searchString" class="form-control" placeholder="Search..." />

                            <div class="input-group-append">
                                <button type="submit" class="btn btn-info"><i class="fas fa-search-plus"></i> Go!</button>
                            </div>
                        </div>
                        <label class="control-label text-right col-md-4" style="color: red;">@ViewBag.ChartOfAccsFound</label>
                    }

                </div>
                <!-- End Search-->
            </div>
             <div class="row">
                 <div class="col-md-6 align-self-center text-left">
                     <!--  Register -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">

                                <table class="table color-bordered-table purple-bordered-table">
                                    <thead>
                                        <tr>

                                            <th>
                                                AccCode
                                            </th>
                                            <th>
                                                AccName
                                            </th>
                                            <th>
                                                AccType
                                            </th>
                                            <th>
                                                AccNo
                                            </th>
                                            <th>
                                                ParentNo
                                            </th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.refChartOfAccsMulti)
                                        {
                                            <tr>

                                                <td>
                                                    @Html.DisplayFor(modelItem => item.AccCode)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.AccName)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.AccType)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.AccNo)
                                                </td>
                                                <td>
                                                    @Html.DisplayFor(modelItem => item.ParentNo)
                                                </td>

                                                <td nowrap="">
                                                    <a class="btn btn-sm btn-rounded btn-primary" asp-action="Edit" asp-route-id="@item.AccNo"><i class="fa fa-edit"></i> Edit</a> |
                                                    <a class="btn btn-sm btn-rounded btn-success" asp-action="Details" asp-route-id="@item.AccNo"><i class="fa  ti-view-list-alt"></i> Details</a> 
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                     <!--  Paging-->
                    <div class="container">
                        @if (pager.TotalPages > 0)
                        {
                            <ul class="pagination justify-content-end">
                                @for (var pge = pager.StartPage; pge <= pager.EndPage; pge++)
                                {
                                    <li class="page-item @(pge == pager.CurrentPage ? "active" : "")">
                                        <a class="page-link" aps-controller="RefPorts" asp-action="Index" asp-route-pg="@pge"> @pge </a>
                                    </li>
                                }
                            </ul>
                            <ul class="pagination justify-content-end">
                                <p> Page @(pager.TotalPages < pager.CurrentPage ? 0 : pager.CurrentPage) of @pager.TotalPages </p>
                            </ul>
                        }
                    </div>
                 </div>
                  <div class="col-md-6 text-left">
                    <!--  Tree view -->
                    <div class="row">
                        <div class="col-md-12" style="margin-left:30px;">
                            <div class="row">
                                <div class="col-md-12">
                                    <div id="treeview">
                                        <ul id="tree">
                                            @if (Model.ChartOfAccViewModelMulti != null)
                                            {
                                                @foreach (var node in Model.ChartOfAccViewModelMulti)
                                                {
                                                    <li id="@node.AccNo" class="parent-node">
                                                        <span class="toggle-node">@node.AccName</span>
                                                        @if (node.Children != null && node.Children.Any())
                                                        {
                                                            <ul class="nested">
                                                                @foreach (var childNode in node.Children)
                                                                {
                                                                    <li id="@childNode.AccNo">
                                                                        <span class="toggle-node">@childNode.AccName</span>
                                                                        @if (childNode.Children != null && childNode.Children.Any())
                                                                        {
                                                                            <ul class="nested">
                                                                                @foreach (var grandChildNode in childNode.Children)
                                                                                {
                                                                                    <li id="@grandChildNode.AccNo">
                                                                                        <span class="toggle-node">@grandChildNode.AccName</span>
                                                                                    </li>
                                                                                }
                                                                            </ul>
                                                                        }
                                                                    </li>
                                                                }
                                                            </ul>
                                                        }
                                                    </li>
                                                }
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                    <div class="col-md-4">
                        <div id="selectedNodeInfo">
                            <!-- Display selected node info here -->
                        </div>
                    </div>
                </div>
             </div>
          
        </div>
        <!-- ============================================================== -->
        <!-- Container fluid  END -->
        <!-- ============================================================== -->

    </div>
</div>
<!-- ============================================================== -->
<!-- Main wrapper -  END style you can find in pages.scss -->
<!-- ============================================================== -->
@section scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI/tZ1ZqjMzl2Al9F2k7tC5Uqq9pMsBzA7Foz/TI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/jstree.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.11/themes/default/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script>
        // Modify your jstree initialization
        $('#treeview').jstree({
            'core': {
                'themes': {
                    'variant': 'large'
                }
            },
            'checkbox': false,
            'plugins': ['wholerow']
        }).on('select_node.jstree', async function (e, data) {
            var selectedNode = data.node;
            $('#selectedNode').val(data.node.id);

            try {
                const response = await getParentInfo(selectedNode.id);
                console.log('AJAX Response:', response); // Add this line for debugging

                var parentInfo = response;
                var accNo = parentInfo.accNo || "N/A";

                // Customize the rendering based on your preference
                var selectedNodeInfo = "<strong>Account No:</strong> " + (accNo === "N/A" ? "Not available" : accNo);
                $('#selectedNodeInfo').html(selectedNodeInfo);
            } catch (error) {
                console.error('AJAX Error:', error); // Add this line for debugging
                $('#selectedNodeInfo').html("Error fetching account number.");
            }
        });

        // Function to get AccNo based on AccNo
        async function getParentInfo(accNo) {
            try {
                const response = await $.ajax({
                    url: '/RefChartOfAccs/GetParentInfo',
                    type: 'GET',
                    data: { accNo: accNo }
                });
                return response;
            } catch (error) {
                console.error("Error fetching account number:", error);
                return { accNo: "N/A" };
            }
        }
    </script>

}
<style>
    #treeview {
        max-height: 600px; /* Set the maximum height for the treeview */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 2px solid #ccc; /* Optional: Add a border for a visual distinction */
    }
</style>